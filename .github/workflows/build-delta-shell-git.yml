# This workflow builds the 'delta-shell-git' AUR package and its dependencies
# It uses an Arch Linux container, installs an AUR helper (paru) to
# build the dependency chain, and then manually builds the final package.

name: Build delta-shell-git

on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
  # Runs on pushes to the main branch
  push:
    branches:
      - main

jobs:
  build:
    name: Build Arch Package
    runs-on: ubuntu-latest

    # Use the official Arch Linux container with base-devel tools
    container:
      image: archlinux:base-devel
      options: --privileged

    steps:
      - name: 1. Set up Environment and Update System
        run: |
          pacman -Syu --noconfirm --needed
          echo "Updated system packages"

      - name: 2. Install Build Tools
        run: |
          # Install basic tools needed to build paru and our package
          pacman -S --noconfirm --needed git rust
          echo "Installed build tools"

      - name: 3. Install 'paru' (AUR Helper)
        run: |
          # We need an AUR helper to build the AUR dependencies
          # We build 'paru' from source here.
          # We run as 'nobody' user to build the package securely.
          pacman -S --noconfirm --needed rust
          
          # Create a non-root build user
          useradd -m builduser
          
          # Give the build user passwordless sudo rights to install packages
          echo 'builduser ALL=(ALL) NOPASSWD: /usr/bin/pacman' >> /etc/sudoers
          
          # Switch to the build user to build paru
          sudo -u builduser bash <<'EOF'
          cd ~
          git clone https://aur.archlinux.org/paru.git
          cd paru
          makepkg -si --noconfirm
          EOF
          
          # Clean up sudoers
          sed -i '$ d' /etc/sudoers
          
          echo "Installed paru AUR helper"

      - name: 4. Download Repository Dependencies
        run: |
          # Download all repo dependencies to the pacman cache
          # We use --downloadonly so they aren't installed
          # We use -dd to skip dependency checks (we just want the files)
          pacman -Sdd --downloadonly --noconfirm --needed \
            git \
            rust \
            go \
            meson \
            vala \
            glib2 \
            json-glib \
            gobject-introspection \
            npm \
            gjs \
            brightnessctl \
            dart-sass \
            fd \
            bluez \
            power-profiles-daemon \
            cliphist \
            gpu-screen-recorder \
            wl-clipboard \
            gtk-layer-shell
          echo "Downloaded all repository dependencies to /var/cache/pacman/pkg/"

      - name: 5. Build and Install AUR Dependencies
        run: |
          # Use 'paru' as the build user to resolve, build, and *install*
          # the entire AUR dependency tree for delta-shell-git.
          # The built packages will be cached in /home/builduser/.cache/paru/pkg/
          sudo -u builduser bash <<'EOF'
          paru -S --noconfirm --needed \
            gtk4-layer-shell \
            libastal \
            libastal-4 \
            libastal-niri-git \
            aylurs-gtk-shell-git
          EOF
          echo "Built and installed all AUR dependencies"

      - name: 6. Build 'delta-shell-git' Package
        run: |
          # Finally, clone and build the target package as the build user
          # All dependencies (repo and AUR) are already installed.
          sudo -u builduser bash <<'EOF'
          cd ~
          git clone https://aur.archlinux.org/delta-shell-git.git
          cd delta-shell-git
          # Use 'makepkg -f' (force) because we are in a clean environment
          # Do not use '-s' as we have already installed all dependencies.
          makepkg -f --noconfirm
          EOF
          echo "Built delta-shell-git package"

      - name: 7. Consolidate All Packages
        run: |
          # Create a single directory to hold all packages
          mkdir -p /home/builduser/all-packages
          
          # Move repo dependencies (needs root)
          mv /var/cache/pacman/pkg/*.pkg.tar.zst /home/builduser/all-packages/
          
          # Move AUR dependencies (as builduser)
          sudo -u builduser bash <<'EOF'
          # Move paru's cached builds
          if ls /home/builduser/.cache/paru/pkg/*.pkg.tar.zst 1> /dev/null 2>&1; then
            mv /home/builduser/.cache/paru/pkg/*.pkg.tar.zst /home/builduser/all-packages/
          fi
          
          # Move the main package build
          mv /home/builduser/delta-shell-git/*.pkg.tar.zst /home/builduser/all-packages/
          EOF
          
          # Fix permissions for the artifact upload
          chown -R builduser:builduser /home/builduser/all-packages
          echo "Moved all .pkg.tar.zst files to /home/builduser/all-packages/"

      - name: 8. Upload All-Packages Artifact
        uses: actions/upload-artifact@v4
        with:
          name: all-packages
          # The packages are all in this one directory
          path: /home/builduser/all-packages/
