name: Build cairo-dock
on:
  workflow_dispatch:
  push:
    branches:
      - main
jobs:
  build:
    name: Build Arch Package
    runs-on: ubuntu-latest
    container:
      image: archlinux:base-devel
      options: --privileged
    steps:
      - name: 1. Set up Environment and Update System
        run: |
          pacman -Syu --noconfirm --needed
          echo "Updated system packages"

      - name: 2. Install Build Tools
        run: |
          pacman -S --noconfirm --needed git base-devel cmake extra-cmake-modules wayland-protocols glu curl
          echo "Installed build tools"

      - name: 3. Install 'paru' (AUR Helper)
        run: |
          pacman -S --noconfirm --needed rust
         
          useradd -m builduser
         
          echo 'builduser ALL=(ALL) NOPASSWD: /usr/bin/pacman' >> /etc/sudoers
         
          sudo -u builduser bash <<'EOF'
          cd ~
          git clone https://aur.archlinux.org/paru.git
          cd paru
          makepkg -si --noconfirm
          EOF
         
          echo "Installed paru AUR helper"

      - name: 4. Download Repository Dependencies
        run: |
          pacman -Sdd --downloadonly --noconfirm --needed \
            gtk3 \
            gdk-pixbuf2 \
            glib2 \
            cairo \
            pango \
            librsvg \
            dbus \
            dbus-glib \
            libxml2 \
            libxrender \
            glu \
            curl \
            libx11 \
            libxtst \
            libxcomposite \
            libxrandr \
            libxinerama \
            wayland \
            json-c \
            gtk-layer-shell
          echo "Downloaded all repository dependencies to /var/cache/pacman/pkg/"

      - name: 5. Build and Install AUR Dependencies
        run: |
          # No known AUR dependencies for cairo-dock (gtk-layer-shell is in extra repo)
          echo "No AUR dependencies to build"

      - name: 6. Build 'cairo-dock' Package
        run: |
          # Create a local directory with the custom PKGBUILD and source
          # (assuming the PKGBUILD content is in the repo at the same location as this workflow)
          mkdir -p /home/builduser/cairo-dock-src
          cp PKGBUILD /home/builduser/cairo-dock-src/  # Adjust if the path differs; "directory location is same"
          chown -R builduser:builduser /home/builduser/cairo-dock-src
         
          sudo -u builduser bash <<'EOF'
          cd ~/cairo-dock-src
          # Download the source (as specified in the PKGBUILD)
          curl -L -o cairo-dock-3.6.1.1.tar.gz "https://github.com/n3ptune-plan3t/cairo-dock-core/archive/3.6.1.1.tar.gz"
          # Verify checksum if needed (already in PKGBUILD)
          makepkg -f --noconfirm
          EOF
          echo "Built cairo-dock package"

      - name: 7. Consolidate All Packages
        run: |
          mkdir -p /home/builduser/all-packages
         
          # Move downloaded repo dependencies
          mv /var/cache/pacman/pkg/*.pkg.tar.zst /home/builduser/all-packages/ 2>/dev/null || true
         
          # Move the main package
          sudo -u builduser bash <<'EOF'
          mv ~/cairo-dock-src/*.pkg.tar.zst /home/builduser/all-packages/
          EOF
         
          chown -R builduser:builduser /home/builduser/all-packages
         
          sed -i '/^builduser/d' /etc/sudoers
         
          echo "Moved all .pkg.tar.zst files to /home/builduser/all-packages/"

      - name: 8. Upload All-Packages Artifact
        uses: actions/upload-artifact@v4
        with:
          name: all-packages
          path: /home/builduser/all-packages/
