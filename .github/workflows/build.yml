name: Build Arch Packages
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # -----------------------------------------------------------------
    # STEP: Build and Sign the package using Docker
    # -----------------------------------------------------------------
    - name: Build and Sign package
      id: build
      env:
        GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
      run: |
        docker run --rm \
          -v "${GITHUB_WORKSPACE}:/github/workspace" \
          -w /github/workspace \
          -e GPG_PRIVATE_KEY \
          -e GPG_PASSPHRASE \
          archlinux:latest /bin/bash -c "
          set -ex

          # --- 1. Setup Environment ---
          echo 'Setting up environment...'
          pacman-key --init

          # --- 2. Install Dependencies ---
          echo 'Installing dependencies...'
          pacman -Syu --noconfirm base-devel git sudo libx11 libxcb libxau libxdmcp xcb-proto xorgproto

          # --- 3. Configure sudoers for builder ---
          echo 'Configuring sudoers...'
          echo 'builder ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers

          # --- 4. Create and Setup Builder User ---
          echo 'Creating builder user...'
          useradd -m builder
          chown -R builder:builder /github/workspace

          # --- 5. Import GPG Key as Builder User ---
          echo 'Importing GPG key as builder...'
          sudo -u builder bash -c '
            mkdir -p ~/.gnupg
            echo \"$GPG_PRIVATE_KEY\" | gpg --batch --import --passphrase \"$GPG_PASSPHRASE\"
          '

          # --- 6. Get KEY_ID as Builder User ---
          KEY_ID=\$(sudo -u builder gpg --list-secret-keys --with-colons | grep '^sec:' | cut -d: -f5)
          if [ -z \"\$KEY_ID\" ]; then
            echo '::error::No GPG secret key found!'
            sudo -u builder gpg --list-secret-keys
            exit 1
          fi
          echo 'Using GPG Key ID: \$KEY_ID'

          # --- 7. Run makepkg as Builder User ---
          echo 'Running makepkg...'
          cd /github/workspace/packages/windowlist
          sudo -u builder makepkg --noconfirm --skippgpcheck --sign --key \"\$KEY_ID\"

          # --- 8. Set Outputs ---
          echo 'Finding package file...'
          PACKAGE_FILE_ZST=\$(find . -maxdepth 1 -name '*.pkg.tar.zst' -print -quit)

          if [ -z \"\$PACKAGE_FILE_ZST\" ]; then
            echo '::error::Package build failed or .zst file not found.'
            exit 1
          fi

          PACKAGE_FILENAME=\$(basename \$PACKAGE_FILE_ZST)
          echo 'Found package: \$PACKAGE_FILENAME'
          echo 'package=\$PACKAGE_FILENAME' >> \$GITHUB_OUTPUT
          echo 'success=true' >> \$GITHUB_OUTPUT
          "

    - name: Deploy to GitHub Pages
      # Only deploy if on main AND the build step was successful
      if: github.ref == 'refs/heads/main' && steps.build.outputs.success == 'true'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./packages/windowlist  # Adjust if needed to point to the built package
