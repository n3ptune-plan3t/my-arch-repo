name: Build Arch Packages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Import GPG key
      run: |
        # Write private key to a temp file (from GitHub Secret)
        echo "${{ secrets.GPG_PRIVATE_KEY }}" > private-key.asc
        
        # Import with passphrase (unlocks during import)
        echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes --import --pinentry-mode loopback --passphrase-fd 0 private-key.asc
        
        # Clean up the temp file for security
        rm private-key.asc
        
        # Verify import (optional, for debugging)
        gpg --list-secret-keys --keyid-format SHORT
      env:
        GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        
    - name: Build package
      id: build
      uses: heyhusen/archlinux-package-action@v2
      with:
        path: packages/windowlist  # Your PKGBUILD dir
        flags: -s --noconfirm     # -s for signing
        pgpkeys: 4148A59C         # Your key ID
        pgpkeyserver: hkps://keys.openpgp.org  # Match your upload server
        updpkgsums: false
        srcinfo: false
        namcap: true
        aur: false
        archlinux_keyring: true
    
    - name: Generate repo database
      run: |
        mkdir -p release/x86_64
        cp "packages/my-package/*.pkg.tar.zst"* release/x86_64/
        cd release
        repo-add --sign --verify my-repo.db.tar.gz x86_64/*.pkg.tar.zst

    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./release
